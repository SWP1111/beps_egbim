<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸ ë¬¸ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', sans-serif;
        }
        
        body {
            background-color: white;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .filter-bar {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
        }
        
        .filter-label {
            font-weight: bold;
            margin-right: 15px;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .tabs-container {
            display: flex;
            height: calc(100vh - 200px);
            min-height: 500px;
            border: 1px solid #ddd;
        }
        
        .left-tab {
            width: 25%;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }
        
        .right-tab {
            width: 75%;
            overflow-y: auto;
        }
        
        .content-header, .file-header {
            background-color: #f2f2f2;
            padding: 12px 15px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        
        .content-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .content-item:hover {
            background-color: #f5f5f5;
        }
        
        .file-list {
            width: 100%;
            border-collapse: collapse;
        }
        
        .file-list th {
            background-color: #f2f2f2;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        
        .file-list td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .folder-item {
            display: flex;
            align-items: center;
        }
        
        .folder-icon {
            color: #ffc107;
            margin-right: 8px;
        }
        
        .file-icon {
            color: #ff9800;
            margin-right: 8px;
        }
        
        /* Tree view styles */
        .tree-view {
            list-style: none;
            padding-left: 0;
        }
        
        .tree-node {
            padding: 5px 0;
        }
        
        .tree-folder {
            cursor: pointer;
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        
        .tree-content {
            padding-left: 20px;
            display: none;
        }
        
        .tree-content.expanded {
            display: block;
        }
        
        .toggle-icon {
            display: inline-block;
            width: 15px;
            text-align: center;
            margin-right: 5px;
        }
        
        .tree-file {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) 80px 1fr 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }
        
        .file-details {
            display: none; /* Hide the previous file details container */
        }
        
        .file-detail {
            padding: 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-name {
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-name-content {
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        
        .file-name-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        /* Page detail styles */
        .page-detail {
            display: grid;
            grid-template-columns: minmax(200px, 2fr) 80px 1fr 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 10px;
            background-color: #fafafa;
        }

        .page-detail-name {
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-detail-name-content {
            display: flex;
            align-items: center;
        }

        .page-detail-icon {
            color: #4caf50;
            margin-right: 8px;
            font-size: 12px;
        }

        .page-detail-name-clickable {
            cursor: pointer;
            color: #1976d2;
            text-decoration: underline;
            font-size: 14px;
        }

        .page-detail-name-normal {
            color: #666;
            font-size: 14px;
        }

        .page-detail-icon-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .detail-download-icon {
            cursor: pointer;
            color: #555;
            font-size: 16px;
            padding: 3px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .detail-download-icon:hover {
            background-color: #f5f5f5;
        }

        .detail-upload-icon {
            cursor: pointer;
            color: #4caf50;
            font-size: 16px;
            padding: 3px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .detail-upload-icon:hover {
            background-color: #e8f5e8;
        }
        
        .new-badge {
            display: inline-block;
            background-color: #3f51b5;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .download-icon {
            margin-left: auto;
            cursor: pointer;
            color: #555;
        }
        
        .upload-icon {
            cursor: pointer;
            color: #4caf50;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .upload-icon:hover {
            background-color: #e8f5e8;
        }
        
        .modify-icon {
            cursor: pointer;
            color: #ff9800;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .modify-icon:hover {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .actions-column {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .file-name-clickable {
            cursor: pointer;
            color: #1976d2;
            text-decoration: underline;
        }
        
        .file-name-normal {
            color: inherit;
        }
        
        /* Image modal styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .image-modal-content {
            position: relative;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            background-color: white;
            border-radius: 5px;
        }
        
        .image-modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .image-modal-close:hover {
            color: #000;
        }
        
        .image-modal img {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
        }
        
        .image-modal-title {
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .add-btn, .remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .add-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .remove-btn {
            background-color: #f44336;
            color: white;
        }
        
        .bottom-actions {
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .loading {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .selected {
            background-color: #e3f2fd;
        }

        .file-header {
            background-color: #f2f2f2;
            padding: 12px 15px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            display: grid;
            grid-template-columns: minmax(200px, 2fr) 80px 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="filter-bar">
            <span class="filter-label">ì²˜ë¦¬ìƒíƒœ</span>
            <div class="filter-options">
                <label class="filter-option">
                    <input type="checkbox" checked id="filter-all"> ì „ì²´
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked id="filter-reviewing"> ê²€í† ì¤‘
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked id="filter-rejected"> ë°˜ë ¤
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked id="filter-approved"> ìŠ¹ì¸
                </label>
                <label class="filter-option">
                    <input type="checkbox" checked id="filter-updated"> ì—…ë°ì´íŠ¸
                </label>
            </div>
        </div>
        
        <div class="tabs-container">
            <!-- ì¢Œì¸¡ ì½˜í…ì¸  íƒ­ -->
            <div class="left-tab">
                <div class="content-header">ì½˜í…ì¸ </div>
                
                <!-- ì½˜í…ì¸  ëª©ë¡ - ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ì˜ì—­ -->
                <div id="content-list">
                    <div class="loading">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
                
                <!-- ì¢Œì¸¡ íƒ­ í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="bottom-actions">
                    <div>
                        <button class="add-btn" id="add-content">+</button>
                        <button class="remove-btn" id="remove-content">-</button>
                    </div>
                </div>
            </div>
            
            <!-- ìš°ì¸¡ íŒŒì¼ íƒ­ -->
            <div class="right-tab">
                <div class="file-header">
                    <div>íŒŒì¼ëª…</div>
                    <div>ì‘ì—…</div>
                    <div>ë²„ì „</div>
                    <div>ì‘ì„±ì</div>
                    <div>ê²€í† ì</div>
                    <div>ë“±ë¡ì¼</div>
                    <div>ì²˜ë¦¬ìƒíƒœ</div>
                </div>
                <div id="file-tree-view" class="tree-view">
                    <div class="loading">ì±„ë„ì„ ì„ íƒí•˜ë©´ íŒŒì¼ êµ¬ì¡°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
                
                <!-- ìš°ì¸¡ íƒ­ í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="bottom-actions">
                    <div>
                        <button class="add-btn" id="add-file">+</button>
                        <button class="remove-btn" id="remove-file">-</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <span class="image-modal-close">&times;</span>
            <div class="image-modal-title" id="imageModalTitle">ì´ë¯¸ì§€ ë³´ê¸°</div>
            <img id="imageModalImg" src="" alt="íŒŒì¼ ì´ë¯¸ì§€">
        </div>
    </div>
    
    <script>
        // Authentication check and role-based access control
        document.addEventListener('DOMContentLoaded', function() {
            const userInfo = JSON.parse(localStorage.getItem("loggedInUser") || "{}");
            const roleId = userInfo && userInfo.user ? userInfo.user.role_id : null;
            const userId = userInfo && userInfo.user ? userInfo.user.id : null;
            
            // Store user role ID for later access control checks
            window.userRoleId = roleId;
            window.userId = userId;
            
            // For completely restricted areas (development only)
            if (document.getElementById('filter-all') && roleId !== 1 && roleId !== 2 && roleId !== 999) {
                document.body.innerHTML = `
                    <div style="text-align: center; margin-top: 50px; color: #f44336;">
                        <h1>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h1>
                        <p style="font-size: 1.5rem;">ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <p>í˜„ì¬ ë‹¹ì‹ ì˜ ê¶Œí•œì€ ${roleId || "ì—†ìŒ"}ì…ë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            // Continue with normal page initialization
            initializeContentManager();
            setupFilterHandlers();
            setupTreeViewEventHandlers();
        });
        
        // ìƒíƒœ ê´€ë¦¬
        let currentSelectedChannel = null;
        let hierarchyData = null;
        let userAccessibleFolders = []; // For restricted users
        let userAccessibleFiles = []; // For restricted users
        let r2FileExistenceCache = {}; // Cache for R2 file existence checks
        
        // DOM ìš”ì†Œ
        const contentListElement = document.getElementById('content-list');
        const fileTreeViewElement = document.getElementById('file-tree-view');
        
        // ğŸ”‘ Authentication helper function
        function authenticatedFetch(url, options = {}) {
            // Get JWT token from localStorage
            const userInfo = JSON.parse(localStorage.getItem("loggedInUser") || "{}");
            const jwtToken = userInfo.token;
            
            if (!jwtToken) {
                console.error('ğŸš« No JWT token found in localStorage');
                throw new Error('Authentication token not found');
            }
            
            // Add Authorization header
            const headers = {
                'Authorization': `Bearer ${jwtToken}`,
                ...options.headers
            };
            
            // Only add Content-Type if not uploading FormData
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            
            console.log('ğŸ”‘ Making authenticated request to:', url);
            console.log('ğŸ”‘ JWT token found (length):', jwtToken.length);
            
            return fetch(url, {
                credentials: 'include',
                ...options,
                headers
            });
        }
        
        // í•„í„° í•¸ë“¤ëŸ¬ ì„¤ì •
        function setupFilterHandlers() {
            const filterCheckboxes = document.querySelectorAll('.filter-options input[type="checkbox"]');
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (currentSelectedChannel) {
                        renderFolderFileStructure(currentSelectedChannel);
                    }
                });
            });
        }

        // íŠ¸ë¦¬ ë·° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
        function setupTreeViewEventHandlers() {
            // ì´ë²¤íŠ¸ ìœ„ì„ì„ í†µí•´ í´ë” í† ê¸€ ê¸°ëŠ¥ êµ¬í˜„
            document.getElementById('file-tree-view').addEventListener('click', function(e) {
                const target = e.target.closest('.tree-folder');
                if (target) {
                    const content = target.nextElementSibling;
                    if (content && content.classList.contains('tree-content')) {
                        content.classList.toggle('expanded');
                        
                        // í† ê¸€ ì•„ì´ì½˜ ë³€ê²½
                        const toggleIcon = target.querySelector('.toggle-icon');
                        if (toggleIcon) {
                            toggleIcon.textContent = content.classList.contains('expanded') ? 'â–¼' : 'â–º';
                        }
                    }
                }
            });
        }
        
        // ì½˜í…ì¸  ë§¤ë‹ˆì € ì´ˆê¸°í™”
        async function initializeContentManager() {
            try {
                contentListElement.innerHTML = '<div class="loading">ì½˜í…ì¸  êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
                
                // ì „ì²´ ê³„ì¸µ êµ¬ì¡° ê°€ì ¸ì˜¤ê¸° (API ì‚¬ìš©)
                hierarchyData = await getContentHierarchy();
                
                if (!hierarchyData) {
                    throw new Error('ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ì¼ë°˜ ì‚¬ìš©ìì¸ ê²½ìš° ì ‘ê·¼ ê°€ëŠ¥í•œ í•­ëª© í•„í„°ë§
                if (window.userRoleId !== 1 && window.userRoleId !== 2 && window.userRoleId !== 999) {
                    await getUserAccessibleContent();
                    filterHierarchyForUser();
                }
                
                // ì±„ë„ ëª©ë¡ ë Œë”ë§
                renderChannels();
                
            } catch (error) {
                console.error('ì½˜í…ì¸  êµ¬ì¡°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                contentListElement.innerHTML = '<div class="loading">ì½˜í…ì¸  êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>';
            }
        }
        
        // APIë¥¼ í†µí•´ ê³„ì¸µ êµ¬ì¡° ê°€ì ¸ì˜¤ê¸°
        async function getContentHierarchy() {
            try {
                // API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                const response = await fetch('/contents/hierarchy');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Hierarchy response error:', errorText);
                    throw new Error(`ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('ê³„ì¸µ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                return null;
            }
        }
        
        // ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸° (ì¼ë°˜ ì‚¬ìš©ììš©)
        async function getUserAccessibleContent() {
            try {
                // API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                const response = await fetch(`/contents/user-accessible?user_id=${window.userId}`);
                if (!response.ok) {
                    throw new Error(`ì ‘ê·¼ ê°€ëŠ¥í•œ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                
                const data = await response.json();
                userAccessibleFolders = data.folderIds || [];
                userAccessibleFiles = data.fileIds || [];
                
            } catch (error) {
                console.error('ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥ ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                userAccessibleFolders = [];
                userAccessibleFiles = [];
            }
        }
        
        // ì‚¬ìš©ì ê¶Œí•œì— ë”°ë¼ ê³„ì¸µ êµ¬ì¡° í•„í„°ë§
        function filterHierarchyForUser() {
            if (!hierarchyData || !hierarchyData.channels) {
                return;
            }
            
            // ì ‘ê·¼ ê°€ëŠ¥í•œ ì±„ë„ë§Œ í•„í„°ë§
            hierarchyData.channels = hierarchyData.channels.filter(channel => {
                // ì±„ë„ ë‚´ í´ë” í•„í„°ë§
                channel.folders = filterFoldersForUser(channel.folders || []);
                
                // ì ‘ê·¼ ê°€ëŠ¥í•œ í´ë”ê°€ ìˆëŠ” ì±„ë„ë§Œ í‘œì‹œ
                return channel.folders.length > 0;
            });
        }
        
        // í´ë” í•„í„°ë§ (ì¬ê·€ í•¨ìˆ˜)
        function filterFoldersForUser(folders) {
            return folders.filter(folder => {
                // ì´ í´ë”ê°€ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸
                const isAccessible = userAccessibleFolders.includes(folder.id);
                
                // í•˜ìœ„ í´ë” í•„í„°ë§
                if (folder.subfolders && folder.subfolders.length > 0) {
                    folder.subfolders = filterFoldersForUser(folder.subfolders);
                }
                
                // íŒŒì¼ í•„í„°ë§
                if (folder.pages && folder.pages.length > 0) {
                    folder.pages = folder.pages.filter(page => 
                        userAccessibleFiles.includes(page.id)
                    );
                }
                
                // ì´ í´ë”ê°€ ì ‘ê·¼ ê°€ëŠ¥í•˜ê±°ë‚˜ ì ‘ê·¼ ê°€ëŠ¥í•œ í•˜ìœ„ í•­ëª©ì´ ìˆìœ¼ë©´ í¬í•¨
                return isAccessible || 
                       (folder.subfolders && folder.subfolders.length > 0) || 
                       (folder.pages && folder.pages.length > 0);
            });
        }
        
        // ì±„ë„ ëª©ë¡ ë Œë”ë§
        function renderChannels() {
            contentListElement.innerHTML = '';
            
            if (!hierarchyData || !hierarchyData.channels || hierarchyData.channels.length === 0) {
                contentListElement.innerHTML = '<div class="loading">í‘œì‹œí•  ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            hierarchyData.channels.forEach(channel => {
                const contentItem = document.createElement('div');
                contentItem.className = 'content-item';
                contentItem.dataset.id = channel.id;
                
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                
                const folderIcon = document.createElement('span');
                folderIcon.className = 'folder-icon';
                folderIcon.innerHTML = '&#128193;';
                
                folderItem.appendChild(folderIcon);
                folderItem.appendChild(document.createTextNode(channel.name));
                
                if (channel.is_new) {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'new-badge';
                    newBadge.textContent = 'NEW';
                    folderItem.appendChild(newBadge);
                }
                
                contentItem.appendChild(folderItem);
                contentListElement.appendChild(contentItem);
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
                contentItem.addEventListener('click', function() {
                    selectChannel(channel.id);
                });
            });
        }
        
        // ì±„ë„ ì„ íƒ ì²˜ë¦¬
        function selectChannel(channelId) {
            // ì´ë¯¸ ì„ íƒëœ í•­ëª©ì˜ ìŠ¤íƒ€ì¼ ì œê±°
            const contentItems = document.querySelectorAll('.content-item');
            contentItems.forEach(item => item.classList.remove('selected'));
            
            // í˜„ì¬ ì„ íƒëœ í•­ëª© ìŠ¤íƒ€ì¼ ì§€ì •
            const selectedItem = document.querySelector(`.content-item[data-id="${channelId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            currentSelectedChannel = channelId;
            renderFolderFileStructure(channelId);
        }
        
        // í´ë” ë° íŒŒì¼ êµ¬ì¡° ë Œë”ë§
        function renderFolderFileStructure(channelId) {
            fileTreeViewElement.innerHTML = '';
            
            if (!hierarchyData || !hierarchyData.channels) {
                fileTreeViewElement.innerHTML = '<div class="loading">í´ë” ë° íŒŒì¼ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ì„ íƒëœ ì±„ë„ ì°¾ê¸°
            const selectedChannel = hierarchyData.channels.find(channel => channel.id === channelId);
            
            if (!selectedChannel || !selectedChannel.folders || selectedChannel.folders.length === 0) {
                fileTreeViewElement.innerHTML = '<div class="loading">í‘œì‹œí•  í´ë” ë° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // í•„í„° ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
            const filters = {
                all: document.getElementById('filter-all').checked,
                reviewing: document.getElementById('filter-reviewing').checked,
                rejected: document.getElementById('filter-rejected').checked,
                approved: document.getElementById('filter-approved').checked,
                updated: document.getElementById('filter-updated').checked
            };
            
            // ì±„ë„ ê³„ì¸µ êµ¬ì¡° ê°€ì ¸ì˜¤ê¸° (í•„í„° í¬í•¨)
            fetchChannelHierarchy(channelId, filters);
        }
        
        // ì±„ë„ì˜ ê³„ì¸µ êµ¬ì¡° ê°€ì ¸ì˜¤ê¸° (API ì‚¬ìš©)
        async function fetchChannelHierarchy(channelId, filters) {
            try {
                fileTreeViewElement.innerHTML = '<div class="loading">í´ë” ë° íŒŒì¼ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
                
                // í•„í„° JSON ì§ë ¬í™”
                const filtersParam = encodeURIComponent(JSON.stringify(filters));
                
                // API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                const response = await fetch(`/contents/hierarchy/channel/${channelId}?filters=${filtersParam}`);
                if (!response.ok) {
                    throw new Error(`ì±„ë„ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ê³„ì¸µ êµ¬ì¡° í‘œì‹œ
                renderHierarchyTree(data);
            } catch (error) {
                console.error('ì±„ë„ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                fileTreeViewElement.innerHTML = '<div class="loading">í´ë” ë° íŒŒì¼ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>';
            }
        }

        // í´ë”ê°€ í˜„ì¬ í•„í„°ì— ë§ëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function folderMatchesFilter(folder) {
            // ëª¨ë“  í•­ëª© í•„í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë“  í´ë” í¬í•¨
            if (document.getElementById('filter-all').checked) {
                return true;
            }
            
            // í•˜ìœ„ í´ë”ë‚˜ íŒŒì¼ì´ í˜„ì¬ í•„í„°ì— ë§ëŠ” í•­ëª©ì„ í¬í•¨í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
            if (folder.subfolders && folder.subfolders.length > 0) {
                return folder.subfolders.some(subfolder => folderMatchesFilter(subfolder));
            }
            
            // ì´ í´ë”ì˜ íŒŒì¼ ì¤‘ í•„í„°ì— ë§ëŠ” ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸
            if (folder.pages && folder.pages.length > 0) {
                const filterReviewing = document.getElementById('filter-reviewing').checked;
                const filterRejected = document.getElementById('filter-rejected').checked;
                const filterApproved = document.getElementById('filter-approved').checked;
                const filterUpdated = document.getElementById('filter-updated').checked;
                
                return folder.pages.some(page => 
                    (filterReviewing && page.status === 'ê²€í† ì¤‘') ||
                    (filterRejected && page.status === 'ë°˜ë ¤') ||
                    (filterApproved && page.status === 'ìŠ¹ì¸') ||
                    (filterUpdated && page.status === 'ì—…ë°ì´íŠ¸')
                );
            }
            
            return false;
        }

        // ê³„ì¸µ êµ¬ì¡° íŠ¸ë¦¬ ë Œë”ë§
        function renderHierarchyTree(data) {
            fileTreeViewElement.innerHTML = '';
            
            const folders = data.folders || [];
            
            if (folders.length === 0) {
                fileTreeViewElement.innerHTML = '<div class="loading">í‘œì‹œí•  í´ë” ë° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // í´ë”ë¥¼ ì´ë¦„ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
            folders.sort((a, b) => a.name.localeCompare(b.name));
            
            // íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
            const treeRoot = document.createElement('ul');
            treeRoot.className = 'tree-view';
            
            // í´ë” ë Œë”ë§
            folders.forEach(folder => {
                const folderNode = createFolderNode(folder, 0);
                treeRoot.appendChild(folderNode);
            });
            
            fileTreeViewElement.appendChild(treeRoot);
            
            // ëª¨ë“  íŒŒì¼ ID ìˆ˜ì§‘í•˜ê³  R2 ì¡´ì¬ ì—¬ë¶€ ì¼ê´„ í™•ì¸
            const allFileIds = collectAllFileIds(data);
            if (allFileIds.length > 0) {
                batchCheckR2Existence(allFileIds);
            }
        }
        
        // ë°ì´í„°ì—ì„œ ëª¨ë“  íŒŒì¼ ID ìˆ˜ì§‘ (ì¬ê·€ í•¨ìˆ˜)
        function collectAllFileIds(data) {
            let fileIds = [];
            
            function collectFromFolders(folders) {
                folders.forEach(folder => {
                    // ì´ í´ë”ì˜ í˜ì´ì§€ë“¤
                    if (folder.pages && folder.pages.length > 0) {
                        folder.pages.forEach(page => {
                            fileIds.push(page.id);
                        });
                    }
                    
                    // í•˜ìœ„ í´ë”ë“¤ ì¬ê·€ ì²˜ë¦¬
                    if (folder.subfolders && folder.subfolders.length > 0) {
                        collectFromFolders(folder.subfolders);
                    }
                });
            }
            
            if (data.folders) {
                collectFromFolders(data.folders);
            }
            
            return fileIds;
        }
        
        // R2 íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì¼ê´„ í™•ì¸
        async function batchCheckR2Existence(fileIds) {
            try {
                console.log(`ğŸ” Checking R2 existence for ${fileIds.length} files...`);
                
                const response = await authenticatedFetch('/contents/files/r2-batch-check', {
                    method: 'POST',
                    body: JSON.stringify({
                        file_ids: fileIds
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`R2 ì¼ê´„ í™•ì¸ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const results = await response.json();
                
                // ìºì‹œì— ê²°ê³¼ ì €ì¥
                Object.assign(r2FileExistenceCache, results);
                
                console.log(`âœ… R2 existence check complete. Found ${Object.keys(results).filter(id => results[id].r2_exists).length} files with R2 images.`);
                
                // UI ì—…ë°ì´íŠ¸
                updateFileNodesWithR2Status();
                
            } catch (error) {
                console.error('R2 ì¼ê´„ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°œë³„ í™•ì¸ìœ¼ë¡œ í´ë°±í•˜ì§€ ì•Šê³  ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            }
        }
        
        // R2 ìƒíƒœì— ë”°ë¼ íŒŒì¼ ë…¸ë“œ UI ì—…ë°ì´íŠ¸
        function updateFileNodesWithR2Status() {
            // ëª¨ë“  íŒŒì¼ ë…¸ë“œ ì°¾ê¸°
            const fileNodes = document.querySelectorAll('.tree-file');
            
            fileNodes.forEach(fileNode => {
                const fileId = fileNode.closest('.tree-node').dataset.id;
                const r2Status = r2FileExistenceCache[fileId];
                
                if (!r2Status) return;
                
                // íŒŒì¼ëª… ìš”ì†Œ ë° ì•¡ì…˜ ì»¬ëŸ¼ ì°¾ê¸°
                const fileNameText = fileNode.querySelector('.file-name-content .file-name-text');
                const actionsColumn = fileNode.parentNode.querySelector('.actions-column');
                
                if (!fileNameText || !actionsColumn) return;
                
                // ê¸°ì¡´ ì•„ì´ì½˜ë“¤ ì œê±°
                actionsColumn.innerHTML = '';
                
                if (r2Status.r2_exists) {
                    // R2ì— íŒŒì¼ì´ ì¡´ì¬ - í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê³  ìˆ˜ì • ì•„ì´ì½˜ ì¶”ê°€
                    fileNameText.className = 'file-name-clickable file-name-text';
                    fileNameText.style.cursor = 'pointer';
                    fileNameText.style.color = '#1976d2';
                    fileNameText.style.textDecoration = 'underline';
                    
                    // í´ë¦­ ì´ë²¤íŠ¸ ì œê±° í›„ ì¬ì¶”ê°€
                    const newFileNameText = fileNameText.cloneNode(true);
                    fileNameText.parentNode.replaceChild(newFileNameText, fileNameText);
                    
                    newFileNameText.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showImageModal(fileId, newFileNameText.textContent);
                    });
                    
                    // ìˆ˜ì • ì•„ì´ì½˜ ì¶”ê°€
                    const newModifyIcon = document.createElement('span');
                    newModifyIcon.className = 'modify-icon';
                    newModifyIcon.innerHTML = '&#9998;'; // Edit/pencil icon
                    newModifyIcon.title = 'ì´ë¯¸ì§€ ìˆ˜ì •';
                    newModifyIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        modifyImage(fileId);
                    });
                    
                    actionsColumn.appendChild(newModifyIcon);
                    
                } else {
                    // R2ì— íŒŒì¼ì´ ì—†ìŒ - ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë§Œë“¤ê³  ì—…ë¡œë“œ ì•„ì´ì½˜ ì¶”ê°€
                    fileNameText.className = 'file-name-normal file-name-text';
                    fileNameText.style.cursor = 'default';
                    fileNameText.style.color = 'inherit';
                    fileNameText.style.textDecoration = 'none';
                    
                    // í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                    const newFileNameText = fileNameText.cloneNode(true);
                    fileNameText.parentNode.replaceChild(newFileNameText, fileNameText);
                    
                    // ì—…ë¡œë“œ ì•„ì´ì½˜ ì¶”ê°€
                    const newUploadIcon = document.createElement('span');
                    newUploadIcon.className = 'upload-icon';
                    newUploadIcon.innerHTML = '&#8593;'; // Upload arrow
                    newUploadIcon.title = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ';
                    newUploadIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        uploadImage(fileId);
                    });
                    
                    actionsColumn.appendChild(newUploadIcon);
                }
            });
        }
        
        // ë‹¨ì¼ íŒŒì¼ ë…¸ë“œì˜ R2 ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSingleFileNodeR2Status(fileId) {
            const fileNode = document.querySelector(`.tree-node[data-id="${fileId}"] .tree-file`);
            if (!fileNode) return;
            
            const r2Status = r2FileExistenceCache[fileId];
            if (!r2Status) return;
            
            // íŒŒì¼ëª… ìš”ì†Œ ë° ì•¡ì…˜ ì»¬ëŸ¼ ì°¾ê¸°
            const fileNameText = fileNode.querySelector('.file-name-content .file-name-text');
            const actionsColumn = fileNode.parentNode.querySelector('.actions-column');
            
            if (!fileNameText || !actionsColumn) return;
            
            // ê¸°ì¡´ ì•„ì´ì½˜ë“¤ ì œê±°
            actionsColumn.innerHTML = '';
            
            if (r2Status.r2_exists) {
                // R2ì— íŒŒì¼ì´ ì¡´ì¬ - í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê³  ìˆ˜ì • ì•„ì´ì½˜ ì¶”ê°€
                fileNameText.className = 'file-name-clickable file-name-text';
                fileNameText.style.cursor = 'pointer';
                fileNameText.style.color = '#1976d2';
                fileNameText.style.textDecoration = 'underline';
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì œê±° í›„ ì¬ì¶”ê°€
                const newFileNameText = fileNameText.cloneNode(true);
                fileNameText.parentNode.replaceChild(newFileNameText, fileNameText);
                
                newFileNameText.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showImageModal(fileId, newFileNameText.textContent);
                });
                
                // ìˆ˜ì • ì•„ì´ì½˜ ì¶”ê°€
                const newModifyIcon = document.createElement('span');
                newModifyIcon.className = 'modify-icon';
                newModifyIcon.innerHTML = '&#9998;'; // Edit/pencil icon
                newModifyIcon.title = 'ì´ë¯¸ì§€ ìˆ˜ì •';
                newModifyIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    modifyImage(fileId);
                });
                
                actionsColumn.appendChild(newModifyIcon);
                
            } else {
                // R2ì— íŒŒì¼ì´ ì—†ìŒ - ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë§Œë“¤ê³  ì—…ë¡œë“œ ì•„ì´ì½˜ ì¶”ê°€
                fileNameText.className = 'file-name-normal file-name-text';
                fileNameText.style.cursor = 'default';
                fileNameText.style.color = 'inherit';
                fileNameText.style.textDecoration = 'none';
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
                const newFileNameText = fileNameText.cloneNode(true);
                fileNameText.parentNode.replaceChild(newFileNameText, fileNameText);
                
                // ì—…ë¡œë“œ ì•„ì´ì½˜ ì¶”ê°€
                const newUploadIcon = document.createElement('span');
                newUploadIcon.className = 'upload-icon';
                newUploadIcon.innerHTML = '&#8593;'; // Upload arrow
                newUploadIcon.title = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ';
                newUploadIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadImage(fileId);
                });
                
                actionsColumn.appendChild(newUploadIcon);
            }
        }
        
        // í´ë” ë…¸ë“œ ìƒì„± (ì¬ê·€ í•¨ìˆ˜)
        function createFolderNode(folder, depth = 0) {
            const folderLi = document.createElement('li');
            folderLi.className = 'tree-node';
            folderLi.dataset.id = folder.id;
            
            // í´ë” ì´ë¦„ ë° ì•„ì´ì½˜
            const folderDiv = document.createElement('div');
            folderDiv.className = 'tree-folder';
            
            const toggleIcon = document.createElement('span');
            toggleIcon.className = 'toggle-icon';
            toggleIcon.textContent = 'â–º';
            
            const folderIcon = document.createElement('span');
            folderIcon.className = 'folder-icon';
            folderIcon.innerHTML = '&#128193;';
            
            folderDiv.appendChild(toggleIcon);
            folderDiv.appendChild(folderIcon);
            folderDiv.appendChild(document.createTextNode(folder.name));
            
            if (folder.is_new) {
                const newBadge = document.createElement('span');
                newBadge.className = 'new-badge';
                newBadge.textContent = 'NEW';
                folderDiv.appendChild(newBadge);
            }
            
            folderLi.appendChild(folderDiv);
            
            // ì„œë¸Œ í´ë” ë° íŒŒì¼ì„ í¬í•¨í•˜ëŠ” ì»¨í…Œì´ë„ˆ
            const contentUl = document.createElement('ul');
            contentUl.className = 'tree-content';
            
            // ì„œë¸Œ í´ë” ë Œë”ë§ (í•„í„° ì ìš©)
            if (folder.subfolders && folder.subfolders.length > 0) {
                const filteredSubfolders = folder.subfolders.filter(subfolder => 
                    folderMatchesFilter(subfolder)
                );
                
                // ì„œë¸Œí´ë”ë¥¼ ì´ë¦„ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
                filteredSubfolders.sort((a, b) => a.name.localeCompare(b.name));
                
                filteredSubfolders.forEach(subfolder => {
                    const subfolderNode = createFolderNode(subfolder, depth + 1);
                    contentUl.appendChild(subfolderNode);
                });
            }
            
            // íŒŒì¼ ë Œë”ë§ (í•„í„° ì ìš©)
            if (folder.pages && folder.pages.length > 0) {
                const filters = {
                    all: document.getElementById('filter-all').checked,
                    reviewing: document.getElementById('filter-reviewing').checked,
                    rejected: document.getElementById('filter-rejected').checked,
                    approved: document.getElementById('filter-approved').checked,
                    updated: document.getElementById('filter-updated').checked
                };
                
                const filteredFiles = folder.pages.filter(page => {
                    // ëª¨ë“  íŒŒì¼ í¬í•¨ ë˜ëŠ” íŠ¹ì • ìƒíƒœ íŒŒì¼ í¬í•¨
                    return filters.all || 
                           (filters.reviewing && page.status === 'ê²€í† ì¤‘') ||
                           (filters.rejected && page.status === 'ë°˜ë ¤') ||
                           (filters.approved && page.status === 'ìŠ¹ì¸') ||
                           (filters.updated && page.status === 'ì—…ë°ì´íŠ¸');
                });
                
                // íŒŒì¼ì„ ì´ë¦„ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
                filteredFiles.sort((a, b) => (a.name || 'ì œëª© ì—†ìŒ').localeCompare(b.name || 'ì œëª© ì—†ìŒ'));
                
                filteredFiles.forEach(page => {
                    const fileLi = document.createElement('li');
                    fileLi.className = 'tree-node';
                    fileLi.dataset.id = page.id;
                    
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'tree-file';
                    
                    // íŒŒì¼ ì´ë¦„ ë° ì•„ì´ì½˜ (ì²« ë²ˆì§¸ ì—´)
                    const fileNameDiv = document.createElement('div');
                    fileNameDiv.className = 'file-name';
                    
                    // ë‚´ë¶€ ì»¨í…Œì´ë„ˆ ìƒì„±í•˜ì—¬ íŒ¨ë”© ì ìš© (ê¹Šì´ì— ë”°ë¥¸ ë“¤ì—¬ì“°ê¸°)
                    const fileNameContent = document.createElement('div');
                    fileNameContent.className = 'file-name-content';
                    // ê¹Šì´ë³„ ë“¤ì—¬ì“°ê¸° ê³„ì‚° (ê° ê¹Šì´ ë ˆë²¨ë‹¹ 20px)
                    fileNameContent.style.paddingLeft = `${(depth + 1) * 20}px`;
                    
                    const fileIcon = document.createElement('span');
                    fileIcon.className = 'file-icon';
                    fileIcon.innerHTML = '&#128196;';
                    
                    fileNameContent.appendChild(fileIcon);
                    
                    // Create filename text element (initially without checking)
                    // R2 existence will be checked in batch after tree is rendered
                    const fileNameText = document.createElement('span');
                    fileNameText.textContent = page.name || 'ì œëª© ì—†ìŒ';
                    fileNameText.className = 'file-name-normal file-name-text'; // Default state with text truncation
                    
                    fileNameContent.appendChild(fileNameText);
                    
                    if (page.is_new) {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'new-badge';
                        newBadge.textContent = 'NEW';
                        fileNameContent.appendChild(newBadge);
                    }
                    
                    fileNameDiv.appendChild(fileNameContent);
                    fileDiv.appendChild(fileNameDiv);
                    
                    // Actions column (ìƒˆë¡œìš´ ì‘ì—… ì—´)
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'actions-column';
                    
                    // Initially add upload icon (will be updated after R2 check)
                    const uploadIcon = document.createElement('span');
                    uploadIcon.className = 'upload-icon';
                    uploadIcon.innerHTML = '&#8593;'; // Upload arrow
                    uploadIcon.title = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ';
                    uploadIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        uploadImage(page.id);
                    });
                    
                    actionsDiv.appendChild(uploadIcon);
                    fileDiv.appendChild(actionsDiv);
                    
                    // ë²„ì „ ì—´
                    const versionDiv = document.createElement('div');
                    versionDiv.className = 'file-detail';
                    versionDiv.textContent = page.version || '1.0';
                    fileDiv.appendChild(versionDiv);
                    
                    // ì‘ì„±ì ì—´
                    const authorDiv = document.createElement('div');
                    authorDiv.className = 'file-detail';
                    authorDiv.textContent = page.author || '-';
                    fileDiv.appendChild(authorDiv);
                    
                    // ê²€í† ì ì—´
                    const reviewerDiv = document.createElement('div');
                    reviewerDiv.className = 'file-detail';
                    reviewerDiv.textContent = page.reviewer || '-';
                    fileDiv.appendChild(reviewerDiv);
                    
                    // ë“±ë¡ì¼ ì—´
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'file-detail';
                    dateDiv.textContent = page.registration_date || '-';
                    fileDiv.appendChild(dateDiv);
                    
                    // ì²˜ë¦¬ìƒíƒœ ì—´
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'file-detail';
                    statusDiv.textContent = page.status || 'ê²€í† ì¤‘';
                    fileDiv.appendChild(statusDiv);
                    
                    fileLi.appendChild(fileDiv);
                    contentUl.appendChild(fileLi);

                    // Render page details under this page if they exist
                    if (page.details && page.details.length > 0) {
                        page.details.forEach(detail => {
                            const detailLi = document.createElement('li');
                            detailLi.className = 'tree-node';
                            detailLi.dataset.id = detail.id;
                            detailLi.dataset.type = 'page_detail';
                            
                            const detailDiv = document.createElement('div');
                            detailDiv.className = 'page-detail';
                            
                            // Page detail name (first column) 
                            const detailNameDiv = document.createElement('div');
                            detailNameDiv.className = 'page-detail-name';
                            
                            const detailNameContent = document.createElement('div');
                            detailNameContent.className = 'page-detail-name-content';
                            // Add extra indentation for page details (20px more than parent page)
                            detailNameContent.style.paddingLeft = `${(depth + 2) * 20}px`;
                            
                            const detailIcon = document.createElement('span');
                            detailIcon.className = 'page-detail-icon';
                            detailIcon.innerHTML = '&#128206;'; // Document icon
                            
                            detailNameContent.appendChild(detailIcon);
                            
                            // Check if detail has content (object_id is not null/empty)
                            const hasContent = detail.has_content || (detail.object_id && detail.object_id.trim() !== '');
                            
                            // Create detail name text element
                            const detailNameText = document.createElement('span');
                            detailNameText.textContent = detail.name || 'ìƒì„¸ ì •ë³´';
                            detailNameText.className = 'file-name-text'; // Apply text truncation
                            
                            if (hasContent) {
                                // Detail has content - make it clickable for download
                                detailNameText.classList.add('page-detail-name-clickable');
                                detailNameText.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    downloadPageDetail(detail.id, detail.name);
                                });
                            } else {
                                // Detail has no content - normal text
                                detailNameText.classList.add('page-detail-name-normal');
                            }
                            
                            detailNameContent.appendChild(detailNameText);
                            detailNameDiv.appendChild(detailNameContent);
                            detailDiv.appendChild(detailNameDiv);
                            
                            // Actions column for page details
                            const detailActionsDiv = document.createElement('div');
                            detailActionsDiv.className = 'actions-column';
                            
                            if (hasContent) {
                                // Show download icon for details with content
                                const downloadIcon = document.createElement('span');
                                downloadIcon.className = 'detail-download-icon';
                                downloadIcon.innerHTML = '&#8595;'; // Download arrow
                                downloadIcon.title = 'íŒŒì¼ ë‹¤ìš´ë¡œë“œ';
                                downloadIcon.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    downloadPageDetail(detail.id, detail.name);
                                });
                                detailActionsDiv.appendChild(downloadIcon);
                            } else {
                                // Show upload icon for details without content
                                const uploadIcon = document.createElement('span');
                                uploadIcon.className = 'detail-upload-icon';
                                uploadIcon.innerHTML = '&#8593;'; // Upload arrow
                                uploadIcon.title = 'íŒŒì¼ ì—…ë¡œë“œ';
                                uploadIcon.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    uploadPageDetailContent(detail.id);
                                });
                                detailActionsDiv.appendChild(uploadIcon);
                            }
                            
                            detailDiv.appendChild(detailActionsDiv);
                            
                            // Empty columns for page details (they don't have version, author, etc.)
                            for (let i = 0; i < 5; i++) {
                                const emptyDiv = document.createElement('div');
                                emptyDiv.className = 'file-detail';
                                emptyDiv.textContent = '-';
                                emptyDiv.style.color = '#ccc';
                                detailDiv.appendChild(emptyDiv);
                            }
                            
                            detailLi.appendChild(detailDiv);
                            contentUl.appendChild(detailLi);
                        });
                    }
                });
            }
            
            folderLi.appendChild(contentUl);
            
            return folderLi;
        }
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile(fileId) {
            console.log(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ: ${fileId}`);
            
            // ë‹¤ìš´ë¡œë“œ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            window.location.href = `/contents/file/${fileId}/download`;
        }
        
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ (R2 ê¸°ë°˜)
        function uploadImage(fileId) {
            console.log(`ì´ë¯¸ì§€ ì—…ë¡œë“œ: ${fileId}`);
            
            // ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1 && window.userRoleId !== 2) {
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = false;
            
            fileInput.onchange = async function() {
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const imageFile = fileInput.files[0];
                
                // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (100MB ì œí•œ)
                if (imageFile.size > 100 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 100MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    // 1ë‹¨ê³„: ë°±ì—”ë“œì—ì„œ R2 ì—…ë¡œë“œ URL ìš”ì²­
                    console.log('R2 ì—…ë¡œë“œ URL ìš”ì²­ ì¤‘...');
                    const urlResponse = await authenticatedFetch(`/contents/file/${fileId}/r2-upload-url`, {
                        method: 'POST',
                        body: JSON.stringify({
                            filename: imageFile.name,
                            content_type: imageFile.type,
                            file_size: imageFile.size
                        })
                    });
                    
                    if (!urlResponse.ok) {
                        throw new Error(`R2 ì—…ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨: ${urlResponse.status}`);
                    }
                    
                    const urlData = await urlResponse.json();
                    console.log('R2 ì—…ë¡œë“œ URL ë°›ìŒ:', urlData.upload_url);
                    
                    // 2ë‹¨ê³„: R2ì— ì§ì ‘ ì—…ë¡œë“œ
                    console.log('R2ì— ì§ì ‘ ì—…ë¡œë“œ ì¤‘...');
                    const uploadResponse = await fetch(urlData.upload_url, {
                        method: 'PUT',
                        body: imageFile,
                        headers: {
                            'Content-Type': imageFile.type
                        }
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error('âŒ R2 upload failed:', {
                            status: uploadResponse.status,
                            statusText: uploadResponse.statusText,
                            headers: Object.fromEntries(uploadResponse.headers.entries()),
                            body: errorText
                        });
                        throw new Error(`R2 ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadResponse.status} - ${errorText}`);
                    }
                    
                    console.log('R2 ì—…ë¡œë“œ ì™„ë£Œ');
                    
                    // 3ë‹¨ê³„: ë°±ì—”ë“œì— ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸
                    console.log('ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸ ì¤‘...');
                    const confirmResponse = await authenticatedFetch(`/contents/file/${fileId}/confirm-r2-upload`, {
                        method: 'POST',
                        body: JSON.stringify({
                            object_key: urlData.object_key,
                            filename: imageFile.name
                        })
                    });
                    
                    if (!confirmResponse.ok) {
                        throw new Error(`ì—…ë¡œë“œ í™•ì¸ ì‹¤íŒ¨: ${confirmResponse.status}`);
                    }
                    
                    const confirmData = await confirmResponse.json();
                    console.log('ì—…ë¡œë“œ í™•ì¸ ì™„ë£Œ:', confirmData);
                    
                    alert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // R2 ìºì‹œ ì—…ë°ì´íŠ¸
                    r2FileExistenceCache[fileId] = {
                        r2_exists: true,
                        object_key: urlData.object_key
                    };
                    
                    // í•´ë‹¹ íŒŒì¼ ë…¸ë“œë§Œ ì—…ë°ì´íŠ¸
                    updateSingleFileNodeR2Status(fileId);
                    
                    // ì „ì²´ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•Šê³  ìºì‹œëœ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
                    
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                    alert(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            };
            
            fileInput.click();
        }
        
        // ì´ë¯¸ì§€ ìˆ˜ì • (R2 ê¸°ë°˜)
        function modifyImage(fileId) {
            console.log(`ì´ë¯¸ì§€ ìˆ˜ì •: ${fileId}`);
            
            // ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1 && window.userRoleId !== 2) {
                alert('ì´ë¯¸ì§€ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í™•ì¸ ì°½
            if (!confirm('ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = false;
            
            fileInput.onchange = async function() {
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const imageFile = fileInput.files[0];
                
                // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (100MB ì œí•œ)
                if (imageFile.size > 100 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 100MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    // 1ë‹¨ê³„: ë°±ì—”ë“œì—ì„œ R2 ì—…ë¡œë“œ URL ìš”ì²­ (ìˆ˜ì •ìš©)
                    console.log('ìˆ˜ì •ìš© R2 ì—…ë¡œë“œ URL ìš”ì²­ ì¤‘...');
                    const urlResponse = await authenticatedFetch(`/contents/file/${fileId}/r2-upload-url`, {
                        method: 'POST',
                        body: JSON.stringify({
                            filename: imageFile.name,
                            content_type: imageFile.type,
                            file_size: imageFile.size,
                            is_modify: true  // ìˆ˜ì • ëª¨ë“œì„ì„ í‘œì‹œ
                        })
                    });
                    
                    if (!urlResponse.ok) {
                        throw new Error(`R2 ì—…ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨: ${urlResponse.status}`);
                    }
                    
                    const urlData = await urlResponse.json();
                    console.log('R2 ì—…ë¡œë“œ URL ë°›ìŒ:', urlData.upload_url);
                    
                    // 2ë‹¨ê³„: R2ì— ì§ì ‘ ì—…ë¡œë“œ
                    console.log('R2ì— ì§ì ‘ ì—…ë¡œë“œ ì¤‘...');
                    const uploadResponse = await fetch(urlData.upload_url, {
                        method: 'PUT',
                        body: imageFile,
                        headers: {
                            'Content-Type': imageFile.type
                        }
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        console.error('âŒ R2 upload failed:', {
                            status: uploadResponse.status,
                            statusText: uploadResponse.statusText,
                            headers: Object.fromEntries(uploadResponse.headers.entries()),
                            body: errorText
                        });
                        throw new Error(`R2 ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadResponse.status} - ${errorText}`);
                    }
                    
                    console.log('R2 ì—…ë¡œë“œ ì™„ë£Œ');
                    
                    // 3ë‹¨ê³„: ë°±ì—”ë“œì— ì´ë¯¸ì§€ ìˆ˜ì • í™•ì¸
                    console.log('ì´ë¯¸ì§€ ìˆ˜ì • í™•ì¸ ì¤‘...');
                    const confirmResponse = await authenticatedFetch(`/contents/file/${fileId}/modify-r2-image`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            object_key: urlData.object_key,
                            filename: imageFile.name
                        })
                    });
                    
                    if (!confirmResponse.ok) {
                        throw new Error(`ì´ë¯¸ì§€ ìˆ˜ì • í™•ì¸ ì‹¤íŒ¨: ${confirmResponse.status}`);
                    }
                    
                    const confirmData = await confirmResponse.json();
                    console.log('ì´ë¯¸ì§€ ìˆ˜ì • ì™„ë£Œ:', confirmData);
                    
                    alert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // R2 ìºì‹œ ì—…ë°ì´íŠ¸
                    r2FileExistenceCache[fileId] = {
                        r2_exists: true,
                        object_key: urlData.object_key
                    };
                    
                    // í•´ë‹¹ íŒŒì¼ ë…¸ë“œë§Œ ì—…ë°ì´íŠ¸
                    updateSingleFileNodeR2Status(fileId);
                    
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                    alert(`ì´ë¯¸ì§€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            };
            
            fileInput.click();
        }
        
        // ì´ë¯¸ì§€ ëª¨ë‹¬ í‘œì‹œ (R2 ê¸°ë°˜)
        function showImageModal(fileId, fileName) {
            console.log(`ì´ë¯¸ì§€ ë³´ê¸°: ${fileId}`);
            
            // R2 ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
            authenticatedFetch(`/contents/file/${fileId}/r2-image-url`, {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`R2 ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('imageModalImg');
                const modalTitle = document.getElementById('imageModalTitle');
                
                // ëª¨ë‹¬ ì„¤ì •
                modalTitle.textContent = fileName || 'ì´ë¯¸ì§€ ë³´ê¸°';
                modalImg.src = data.signed_url;
                
                // ëª¨ë‹¬ í‘œì‹œ
                modal.style.display = 'block';
            })
            .catch(error => {
                console.error('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // í˜ì´ì§€ ìƒì„¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadPageDetail(detailId, detailName) {
            console.log(`í˜ì´ì§€ ìƒì„¸ ë‹¤ìš´ë¡œë“œ: ${detailId}`);
            
            try {
                // ì¸ì¦ëœ ìš”ì²­ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸°
                const response = await authenticatedFetch(`/contents/page-detail/${detailId}/download`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                
                // ë¦¬ë””ë ‰ì…˜ ì‘ë‹µì„ ì²˜ë¦¬í•˜ì—¬ ì‹¤ì œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = detailName || `page_detail_${detailId}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('í˜ì´ì§€ ìƒì„¸ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('í˜ì´ì§€ ìƒì„¸ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ìƒì„¸ íŒŒì¼ ì—…ë¡œë“œ
        function uploadPageDetailContent(detailId) {
            console.log(`í˜ì´ì§€ ìƒì„¸ íŒŒì¼ ì—…ë¡œë“œ: ${detailId}`);
            
            // ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1 && window.userRoleId !== 2) {
                alert('íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.webm,.mp4,.avi,.mov,.wmv,.doc,.docx,.ppt,.pptx,.xls,.xlsx';
            fileInput.multiple = false;
            
            fileInput.onchange = function() {
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const contentFile = fileInput.files[0];
                
                // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (100MB ì œí•œ)
                if (contentFile.size > 100 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 100MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('file', contentFile);
                
                // ì¸ì¦ëœ ìš”ì²­ìœ¼ë¡œ ì—…ë¡œë“œ API í˜¸ì¶œ
                authenticatedFetch(`/contents/page-detail/${detailId}/upload-content`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    if (currentSelectedChannel) {
                        const filters = {
                            all: document.getElementById('filter-all').checked,
                            reviewing: document.getElementById('filter-reviewing').checked,
                            rejected: document.getElementById('filter-rejected').checked,
                            approved: document.getElementById('filter-approved').checked,
                            updated: document.getElementById('filter-updated').checked
                        };
                        fetchChannelHierarchy(currentSelectedChannel, filters);
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                    alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            };
            
            fileInput.click();
        }
        
        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imageModal');
            const closeBtn = document.querySelector('.image-modal-close');
            
            // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // ESC í‚¤ ëˆ„ë¥´ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            });
        });
        
        // ì½˜í…ì¸  ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('add-content').addEventListener('click', function() {
            console.log('ì±„ë„ ì¶”ê°€');
            
            // ê´€ë¦¬ì ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1) {
                alert('ì±„ë„ ì¶”ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì±„ë„ ì´ë¦„ ì…ë ¥ ë°›ê¸°
            const channelName = prompt("ì¶”ê°€í•  ì±„ë„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (!channelName) return;
            
            // ì±„ë„ ì¶”ê°€ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            authenticatedFetch('/contents/channel', {
                method: 'POST',
                body: JSON.stringify({ name: channelName })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì±„ë„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // ì¶”ê°€ í›„ ê³„ì¸µ êµ¬ì¡° ìƒˆë¡œê³ ì¹¨
                initializeContentManager();
            })
            .catch(error => {
                console.error('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
        
        // ì½˜í…ì¸  ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('remove-content').addEventListener('click', function() {
            if (!currentSelectedChannel) {
                alert('ì‚­ì œí•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê´€ë¦¬ì ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1) {
                alert('ì±„ë„ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í™•ì¸ ì°½
            if (!confirm("ì •ë§ë¡œ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            
            // ì±„ë„ ì‚­ì œ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            authenticatedFetch(`/contents/channel/${currentSelectedChannel}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ì±„ë„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // ì‚­ì œ í›„ ê³„ì¸µ êµ¬ì¡° ìƒˆë¡œê³ ì¹¨
                currentSelectedChannel = null;
                initializeContentManager();
            })
            .catch(error => {
                console.error('ì±„ë„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('ì±„ë„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
        
        // íŒŒì¼ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('add-file').addEventListener('click', function() {
            if (!currentSelectedChannel) {
                alert('íŒŒì¼ì„ ì¶”ê°€í•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì ì ˆí•œ ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1 && window.userRoleId !== 2) {
                alert('íŒŒì¼ ì¶”ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = false;
            
            fileInput.onchange = function() {
                if (!fileInput.files || fileInput.files.length === 0) {
                    return;
                }
                
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('channelId', currentSelectedChannel);
                
                // íŒŒì¼ ì—…ë¡œë“œ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                authenticatedFetch('/contents/file', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`íŒŒì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                    }
                    return response.json();
                })
                .then(() => {
                    // ì¶”ê°€ í›„ ê³„ì¸µ êµ¬ì¡° ìƒˆë¡œê³ ì¹¨
                    if (currentSelectedChannel) {
                        const filters = {
                            all: document.getElementById('filter-all').checked,
                            reviewing: document.getElementById('filter-reviewing').checked,
                            rejected: document.getElementById('filter-rejected').checked,
                            approved: document.getElementById('filter-approved').checked,
                            updated: document.getElementById('filter-updated').checked
                        };
                        fetchChannelHierarchy(currentSelectedChannel, filters);
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                    alert('íŒŒì¼ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            };
            
            fileInput.click();
        });
        
        // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('remove-file').addEventListener('click', function() {
            // íŠ¸ë¦¬ì—ì„œ ì„ íƒëœ íŒŒì¼ ë° í˜ì´ì§€ ìƒì„¸ ì°¾ê¸°
            const selectedFiles = document.querySelectorAll('.tree-file.selected');
            const selectedDetails = document.querySelectorAll('.page-detail.selected');
            
            if (selectedFiles.length === 0 && selectedDetails.length === 0) {
                alert('ì‚­ì œí•  íŒŒì¼ ë˜ëŠ” í˜ì´ì§€ ìƒì„¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì ì ˆí•œ ê¶Œí•œ ê²€ì‚¬
            if (window.userRoleId !== 999 && window.userRoleId !== 1 && window.userRoleId !== 2) {
                alert('íŒŒì¼ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í™•ì¸ ì°½
            const totalSelected = selectedFiles.length + selectedDetails.length;
            if (!confirm(`ì„ íƒí•œ ${totalSelected}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ì„ íƒëœ íŒŒì¼ ID ë°°ì—´ ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ì™€ í˜ì´ì§€ ìƒì„¸ ëª¨ë‘ í¬í•¨)
            const fileIds = Array.from(selectedFiles).map(file => 
                file.closest('.tree-node').dataset.id
            );
            const detailIds = Array.from(selectedDetails).map(detail => 
                detail.closest('.tree-node').dataset.id
            );
            
            // ëª¨ë“  IDë¥¼ í•©ì¹¨ (APIëŠ” í˜ì´ì§€ì™€ í˜ì´ì§€ ìƒì„¸ ëª¨ë‘ ì²˜ë¦¬ ê°€ëŠ¥)
            const allIds = [...fileIds, ...detailIds];
            
            // íŒŒì¼ ì‚­ì œ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            authenticatedFetch('/contents/files', {
                method: 'DELETE',
                body: JSON.stringify({ fileIds: allIds })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // ì‚­ì œ í›„ ê³„ì¸µ êµ¬ì¡° ìƒˆë¡œê³ ì¹¨
                if (currentSelectedChannel) {
                    const filters = {
                        all: document.getElementById('filter-all').checked,
                        reviewing: document.getElementById('filter-reviewing').checked,
                        rejected: document.getElementById('filter-rejected').checked,
                        approved: document.getElementById('filter-approved').checked,
                        updated: document.getElementById('filter-updated').checked
                    };
                    fetchChannelHierarchy(currentSelectedChannel, filters);
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
        
        // íŒŒì¼ ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€
        document.addEventListener('click', function(e) {
            const fileNode = e.target.closest('.tree-file');
            const detailNode = e.target.closest('.page-detail');
            
            if (fileNode || detailNode) {
                // ì´ë¯¸ ì„ íƒëœ íŒŒì¼/ìƒì„¸ ì„ íƒ í•´ì œ
                document.querySelectorAll('.tree-file.selected, .page-detail.selected').forEach(node => {
                    node.classList.remove('selected');
                });
                
                // í˜„ì¬ íŒŒì¼/ìƒì„¸ ì„ íƒ
                if (fileNode) {
                    fileNode.classList.add('selected');
                } else if (detailNode) {
                    detailNode.classList.add('selected');
                }
            }
        });
    </script>
</body>
</html>