<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BEPs 로그인</title>

  <style>
    .login-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh; /* 전체 화면 기준 가운데 정렬 */
    }

    .login-container {
      width: 400px;
      margin: 0 auto;
    }
  </style>
  
  <!-- Descope SDK & Web Component -->
  <script src="https://descopecdn.com/npm/@descope/web-js-sdk@1.16.0/dist/index.umd.js"></script>
  <script src="https://descopecdn.com/npm/@descope/web-component@3.21.0/dist/index.js"></script>
  <script src="/asset/js/config.js"></script>
  <script src="/asset/js/verifyCookie.js"></script>
</head>

<body>
  <!-- 로그인 UI -->
   <div class="login-wrapper">
      <div class="login-container">
        <descope-wc 
          project-id="P2wON5fy1K6kyia269VpeIzYP8oP" 
          flow-id="sign-up-with-password-for-beps"
          base-url="https://api.descope.com"></descope-wc>
          <!-- form='{"email":"user@example.com"}' --> <!-- 초기값 설정 가능하네?-->
          <div id="output" style="color: red; margin-top: 10px;"></div>
    </div>  
   </div>

  <script>
    const wcElement = document.querySelector('descope-wc');

    //const sdk = Descope({
    //    projectId: 'P2wON5fy1K6kyia269VpeIzYP8oP',
    //    baseUrl: 'https://api.descope.com',
    //    persistTokens: true,
    //    autoRefresh: true,
    //  });

    (async () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const token = params.get('token');
      const refreshToken = params.get('refreshJwt');

      if(params.size > 0) { // URL에 파라미터가 있는 경우 - 체크해서 로그인 SKIP
        if(id && token && refreshToken) {
          if(await GetUserInfoByRefreshJWT(id, refreshToken)){
            window.location.href = "/main.html?content=opinion";
          }
        }
      }
      else {  // URL에 파라미터가 없는 경우 - 로그인 체크
        const getRefreshJwt = null;//sdk.getRefreshToken();
        if(getRefreshJwt)
        {
          const id = await GetAuthMeByRefreshJWT(getRefreshJwt);
          if(id != null && await GetUserInfoByRefreshJWT(id, getRefreshJwt))
            window.location.href = "/main.html";
        }
      }
    })();
   
    wcElement.addEventListener('success', async (e) => {
      
      if(e.detail === null)
      {
        window.location.reload();
        return;
      }
       
      const {sessionJwt, refreshJwt, user} = e.detail;

      var insertResult = await InsertUser(user.customAttributes.familyUniqueKey, 
                      user.customAttributes.familyCompany, 
                      user.customAttributes.team, 
                      user.customAttributes.position, 
                      user.name,
                      user.email,
                      user.phone);
      if(insertResult.success === false)
      {
        if(insertResult.data && insertResult.data.error)
          output.textContent = "❌ 사용자 정보 등록 실패:\n" + insertResult.data.error;
        else
          output.textContent = "❌ 사용자 정보 등록 실패: 알 수 없는 오류가 발생했습니다.";
        return;
      }
      
      const authUserInfo = await AuthUserInfo(user.customAttributes.familyUniqueKey, refreshJwt);
        if(authUserInfo.success)
        {
          sessionStorage.setItem("isLoggedIn", "true");
          sessionStorage.setItem("username", user.name);
          sessionStorage.setItem("loggedInUser", JSON.stringify(authUserInfo.data));

          window.location.href = "/main.html";
        }
    });

    wcElement.addEventListener('error', (err) => {
      output.textContent = "❌ 로그인 실패:\n" + JSON.stringify(err);
    });

    async function checkValidateToken(token) {
      try{
        const response = await fetch('https://api.descope.com/v1/auth/validate', {
          method: 'POST',
          headers: { Authorization: `Bearer P2wON5fy1K6kyia269VpeIzYP8oP:${token}` }
        });

        if(!response.ok) {
          throw new Error("토큰 검증 실패");
        }

        const data = await response.json();
        return true; // 토큰이 유효함
      }
      catch (error) {
        return false; // 토큰이 유효하지 않음
      }
    }

    async function AuthUserInfo(id, refreshToken) {
      const url = `${window.baseUrl}user/user`;
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: id,
          descope_refresh_jwt: refreshToken,
          save_refresh_jwt: true
        })
      });

      const responseJson = await response.json();
      if(response.ok)
      {
        return {success: true, data: responseJson}
      }
      else
      {
        return {success: false, message: "사용자 없음"}
      }
    }
 
    async function GetUserInfoByRefreshJWT(id, refreshToken){
      
      const authUserInfo = await AuthUserInfo(id, refreshToken);

      if(authUserInfo.success == true)
      {
        sessionStorage.setItem("isLoggedIn", "true");
        sessionStorage.setItem("username", authUserInfo.data.user.name);
        sessionStorage.setItem("loggedInUser", JSON.stringify(authUserInfo.data));
        return true; // 사용자 정보 조회 성공
      }
      else 
        return false; // 사용자 정보 조회 실패
    }

    async function GetAuthMeByRefreshJWT(refreshJwt) {
      const response = await fetch(`${window.baseUrl}user/descope/get_user_info`, {
        method: "GET",
        headers: {
          "X-Descope-Refresh-Token": refreshJwt
        }
      });
      const data = await response.json();

      if(response.ok) {
        return data.customAttributes.familyUniqueKey;
      }
      return null; // 사용자 정보 조회 실패
    }

    async function InsertUser(id, company, department, position, name, email, phone)
    {
        try{

            url = `${baseUrl}user/update_user`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id: id,
                    company : company,
                    department : department,
                    position : position,
                    name : name,
                    email : email,
                    phone : phone
                })
            });

            const responseJson = await response.json();
            console.log("InsertUser 서버 응답: ", responseJson);

            if(response.ok)
            {
                return {success: true, data: responseJson}
            }
            else
            {
                return {success: false, data: responseJson};
            }

        }catch(error){
            console.error(error);
        }
    }

    async function GetAPITokenCheck()
    {
      const response = await fetch(`${window.baseUrl}user/token_check`, {
        method: "GET",
        credentials: 'include'
      });

      if(response.ok) {
        return true; // API 토큰 조회 성공
      }
      return false; // API 토큰 조회 실패
    }
    
  </script>
</body>
</html>
