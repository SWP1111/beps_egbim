<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업데이트 콘텐츠 목록</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 12px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .content-container {
            overflow-y: auto;
            flex: 1;
            padding-bottom: 20px; /* pagination과 겹치지 않게 */
        }
        
        table { 
            border-collapse: collapse; 
            width: 100%; 
        }
        th, td { 
            padding: 8px; 
            text-align: center;
            font-size: 12px;
        }
        th { 
            background-color: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #ffffff;
        }
        
        .pagination {
            position: sticky;
            bottom: 0px;
            left: 0;
            width: 100%;
            background-color: white;
            padding: 10px 0;
            text-align: center;
        }
        
        .pagination button {
            padding: 5px 10px; 
            margin: 0 3px; 
            font-size: 12px;
            border: none;
            outline: none;
            background: white;
            cursor: pointer;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: bold;
        }
        
        .pagination button:hover {
            background-color: #f8f9fa;
        }
        
        .pagination button.active {
            color: #007bff;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        /* 컬럼 너비 설정 */
        .title-col { width: 50%; }
        .date-col { width: 20%; text-align: center; }
        .manager-col { width: 30%; }
        
        /* 텍스트 말줄임 처리 */
        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <script src="asset/js/config.js"></script>
</head>
<body>
    <div class="container">
        <div class="content-container">
            <table>
                <thead>
                    <tr>
                        <th class="title-col">제목</th>
                        <th class="date-col">날짜</th>
                        <th class="manager-col">담당자</th>
                    </tr>
                </thead>
                <tbody id="updateTableBody">
                    <tr>
                        <td colspan="3" class="loading">데이터를 불러오는 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="pagination" id="pagination" style="display: none;">
        </div>
    </div>
    
    <script>
        let contents = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // 파일 이름 정리 함수
        function cleanFileName(name) {
            return name.replace(/^\d+_/, '').replace(/\.[^/.]+$/, '');
        }
        
        // 날짜 포맷팅 함수
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }
        
        // 부모 창에서 데이터를 받는 함수
        function setUpdateContentsData(data) {
            contents = data || [];
            currentPage = 1;
            renderTable(currentPage);
            renderPagination();
        }
        
        // 테이블 렌더링 함수
        function renderTable(page) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageContents = contents.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('updateTableBody');
            tbody.innerHTML = '';
            
            if (pageContents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty">업데이트된 콘텐츠가 없습니다.</td></tr>';
                return;
            }
            
            pageContents.forEach(content => {
                const tr = document.createElement('tr');
                const cleanedName = cleanFileName(content.name);
                const dateStr = formatDate(content.updated_at);
                const textColor = content.viewed_after_update ? '#000' : '#007bff';
                const managerName = content.manager_name || '-';
                
                tr.innerHTML = `
                    <td class="title-col text-ellipsis" style="color: ${textColor};" title="${cleanedName}">
                        ${cleanedName}
                    </td>
                    <td class="date-col" style="color: ${textColor};">
                        ${dateStr}
                    </td>
                    <td class="manager-col text-ellipsis" style="color: ${textColor};" title="${managerName}">
                        ${managerName}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // 페이지네이션 렌더링 함수
        function renderPagination() {
            const totalPages = Math.ceil(contents.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'block';
            pagination.innerHTML = '';
            
            // 이전 버튼
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '<';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable(currentPage);
                    renderPagination();
                }
            };
            pagination.appendChild(prevBtn);
            
            // 페이지 번호들
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderTable(currentPage);
                    renderPagination();
                };
                pagination.appendChild(pageBtn);
            }
            
            // 다음 버튼
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable(currentPage);
                    renderPagination();
                }
            };
            pagination.appendChild(nextBtn);
        }
        
        // 부모창 상태 확인 및 창 닫기
        function checkAndCloseIfParentClosed() {
            if (!window.opener || window.opener.closed) {
                window.close();
            }
        }
        
        // 페이지 로드 시 기본 상태 표시
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('updateTableBody').innerHTML = 
                '<tr><td colspan="3" class="loading">데이터를 받는 중...</td></tr>';
            
            // 부모창 상태 먼저 확인
            if (checkParentWindow()) {
                return;
            }
            
            console.log('Update contents window loaded, opener:', window.opener);
        });
        
        // 창이 포커스를 받을 때 부모창 상태 확인 및 데이터 업데이트
        window.addEventListener('focus', () => {
            checkAndCloseIfParentClosed();
            if (window.opener && window.opener.updateContentsData) {
                setUpdateContentsData(window.opener.updateContentsData);
            }
        });
    </script>
</body>
</html>
