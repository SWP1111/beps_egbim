<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>접속 IP 목록</title>
  <style>
    body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .content-container {
        overflow-y: auto;
        flex: 1;
        padding-bottom: 20px; /* pagination과 겹치지 않게 */
    }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 3px; text-align: center; }
    th { background-color: #f5f5f5; }
    .pagination { 
        position: sticky;
        bottom: 0px;
        left: 0;
        width: 100%;
        background-color: white;
        padding: 10px 0;
        text-align: center;
        border-top: 1px solid #ccc;
    }
    .pagination button {
        padding: 5px 10px; margin: 0 3px; font-size: 13px;
    }
  </style>
  <script src="asset/js/config.js"></script>
</head>
<body>
  <!-- <h3>접속 IP 목록</h3> -->

  <div class="content-container">
    <table>
        <thead>
        <tr><th>IP</th><th>접속일시</th><th>사용자</th></tr>
        </thead>
        <tbody id="ipTableBody">
        <!-- IP 목록이 여기에 동적으로 추가됩니다. -->      
        </tbody>
    </table>
  </div>

  <div class="pagination" id="pagination">
    <span id="pageInfo"></span>
  </div>

  <script>

    const urlParams = new URLSearchParams(window.location.search);
    const periodValue = urlParams.get('period_value');
    const periodType = urlParams.get('period_type');
    const filterType = urlParams.get('filter_type');
    const filterValue = urlParams.get('filter_value');

    async function get_external_ips(page = 1) {
        const params = new URLSearchParams({
            period_value: periodValue,
            period_type: periodType,
            filter_type: filterType,
            filter_value: filterValue
        });

        let url = `${window.baseUrl}/user/get_external_ips?page=${page}&page_size=15&${params.toString()}`;
        const response = await fetch(url);
        const data = await response.json();

        if(response.ok){
            rendterTable(data.data);
            renderPagination(data.total, data.page, data.page_size);
        }
    }


    function rendterTable(data) {
        const tbody = document.getElementById('ipTableBody');
        tbody.innerHTML = ''; // 기존 내용 초기화

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.ip_address}</td>
                <td>${formatDate(row.login_time)}</td>
                <td>${row.user_name}</td>
            `;
            tbody.appendChild(tr);
        })
    }

    function formatDate(iso) {
        if (!iso) return '-';
        const d = new Date(iso);
        
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ` +
         `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
    }

    function renderPagination(total, page, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        const maxMiddleButtons = 5;
        const buttons = [];

        // Always add first page
        buttons.push(1);

        let start = Math.max(2, page - Math.floor(maxMiddleButtons / 2));
        let end = Math.min(totalPages - 1, start + maxMiddleButtons - 1);

        // Adjust if near the end
        if (end > totalPages - 1) {
            end = totalPages - 1;
            start = Math.max(2, end - maxMiddleButtons + 1);
        }

        if (start > 2) {
            buttons.push('...');
        }

        for (let i = start; i <= end; i++) {
            buttons.push(i);
        }

        if (end < totalPages - 1) {
            buttons.push('...');
        }

        if (totalPages > 1) {
            buttons.push(totalPages);
        }

        // Render buttons
        for (const item of buttons) {
            if (item === '...') {
                const span = document.createElement('span');
                span.textContent = '...';
                span.style.margin = '0 4px';
                pagination.appendChild(span);
            }
            else {
                const btn = document.createElement('button');
                btn.textContent = item;
                if (item === page) btn.disabled = true;
                btn.onclick = () => get_external_ips(item);
                pagination.appendChild(btn);
            }
        }
    }
    
    // 초기 로드
    get_external_ips();

  </script>
</body>
</html>